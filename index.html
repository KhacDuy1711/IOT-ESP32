<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Äiá»u khiá»ƒn Ä‘Ã¨n ESP32</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0081C2, #042F60);
      color: white;
      text-align: center;
      padding: 50px;
    }
    h1 {
      margin-bottom: 20px;
    }
    #ledButton {
      padding: 15px 30px;
      font-size: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
    }
    .on {
      background-color: red;
    }
    .off {
      background-color: green;
    }
  </style>
</head>
<body>
  <h1>ğŸ’¡ Äiá»u khiá»ƒn Ä‘Ã¨n ESP32</h1>
  <button id="ledButton" class="off" onclick="toggleLED()">Báº­t Ä‘Ã¨n</button>

  <script>
    // --- Cáº¥u hÃ¬nh ThingSpeak ---
    const writeAPIKey = "GRCJC30IIGGHI4SX";   // API key ghi (Ä‘iá»u khiá»ƒn LED)
    const readAPIKey  = "MG3QHGIIU9UT6SPF";   // API key Ä‘á»c
    const channelID   = "2651233";

    let currentState = "0"; // máº·c Ä‘á»‹nh Ä‘Ã¨n táº¯t

    // Gá»­i lá»‡nh báº­t/táº¯t LED
    function toggleLED() {
      let newState = (currentState === "1") ? "0" : "1";
      fetch(`https://api.thingspeak.com/update?api_key=${writeAPIKey}&field1=${newState}`)
        .then(response => response.text())
        .then(data => {
          if (data !== "0") {
            currentState = newState;
            updateButton();
          } else {
            alert("âš ï¸ Gá»­i lá»‡nh tháº¥t báº¡i!");
          }
        });
    }

    // Cáº­p nháº­t giao diá»‡n nÃºt
    function updateButton() {
      const btn = document.getElementById("ledButton");
      if (currentState === "1") {
        btn.innerText = "Táº¯t Ä‘Ã¨n";
        btn.classList.remove("off");
        btn.classList.add("on");
      } else {
        btn.innerText = "Báº­t Ä‘Ã¨n";
        btn.classList.remove("on");
        btn.classList.add("off");
      }
    }

    // Äá»c tráº¡ng thÃ¡i LED tá»« ThingSpeak
    function fetchLEDState() {
      fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1/last.txt?api_key=${readAPIKey}`)
        .then(response => response.text())
        .then(state => {
          state = state.trim();
          if (state === "0" || state === "1") {
            currentState = state;
            updateButton();
          }
        });
    }

    // Auto sync má»—i 3s
    setInterval(fetchLEDState, 3000);

    // Sync ngay khi load trang
    window.onload = fetchLEDState;
  </script>
</body>
</html>
