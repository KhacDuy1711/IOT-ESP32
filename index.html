<!DOCTYPE html>
<html>
<head>
<script>
  if (sessionStorage.getItem("authenticated") !== "1") {
    window.location.href = "login.html";
  }
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IOT</title>
<style>
body {font-family: Arial, sans-serif; background: linear-gradient(45deg, #0081C2,#042F60, #0081C2); margin:0;min-height: 100vh; background-attachment: fixed;background-size: cover;padding:20px; color:#333;}
.container {display:grid; grid-template-columns: 1fr 1fr; gap:20px; max-width:1200px; margin:auto;}
.card { background:white; border: none;align-items: center; border-radius:20px; padding:20px; box-shadow: -5px 5px 0px #6E8FFF; margin-bottom:20px;}
.btn {font-size:16px; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; transition:0.3s;}
#toggleBtn1 {background:#28a745; color:black;}
#toggleBtn1.on {background:#8B0000; color:white;}
#toggleBtn2 {background:#28a745; color:black;}
#toggleBtn2.on {background:#8B0000; color:white;}
#toggleBtn3 {background:#28a745; color:black;}
#toggleBtn3.on {background:#8B0000; color:white;}
#toggleBtn:hover {opacity:0.85;}
#saveTimeBtn {background:#28a745; color:black;}
#modeBtn {background:#2196F3; color:white;}
#modeBtn.auto {background:orange;}
iframe {width:100%; height:240px; border:none;align-items: center; border-radius:10px; margin-top:10px;}
img {width: 50%;border-radius: 15px;align-items: center;}
#clock {font-size:20px; font-weight:normal; color:#222;}
#clock-date {font-size:20px; font-weight:normal; color:#222;}
</style>
</head>
<body>
<div class='container'>
  <div>
    <div class='card'>
      <h2>üïí Ng√†y th√°ng & gi·ªù hi·ªán t·∫°i</h2>
      <div id='clock-date'>Loading date...</div>
      <div id='clock'>Loading time...</div>
    </div>
    <div class='card'>
      <h2>‚öôÔ∏è Mode</h2>
      <p>Ch·∫ø ƒë·ªô: <span id='modeState'>Manual</span></p>
      <button id='modeBtn' class='btn' onclick='toggleMode()'>Nh·∫•n ƒë·ªÉ ƒë·ªïi Mode</button>
    </div>
    <div id="autoSettings" class="card" style="display:none;">
      <h3>üïì C√†i ƒë·∫∑t th·ªùi gian Auto</h3>
      <div class="time-row">
        <label>‚è∞ Th·ªùi gian B·∫¨T LED (HHMM):</label>
        <input type="text" id="startTime" maxlength="4" placeholder="VD: 1830"
              oninput="this.value=this.value.replace(/[^0-9]/g,'')">
      </div>
      <div class="time-row">
        <label>üí§ Th·ªùi gian T·∫ÆT LED (HHMM):</label>
        <input type="text" id="stopTime" maxlength="4" placeholder="VD: 2230"
              oninput="this.value=this.value.replace(/[^0-9]/g,'')">
      </div>
      <button id="saveTimeBtn" class="btn" onclick="sendTimeToThingSpeak()">üíæ G·ª≠i th·ªùi gian</button>
    </div>
    <div class='card'>
      <h2>üí° ƒêi·ªÅu khi·ªÉn LED</h2>
      <p>Tr·∫°ng th√°i LED 1: <span id='state1'>ƒê√£ T·∫Øt</span></p>
      <button id='toggleBtn1' class='btn' onclick='toggleLED1()'>Nh·∫•n ƒë·ªÉ b·∫≠t / t·∫Øt</button>
      <p>Tr·∫°ng th√°i LED 2: <span id='state2'>ƒê√£ T·∫Øt</span></p>
      <button id='toggleBtn2' class='btn' onclick='toggleLED2()'>Nh·∫•n ƒë·ªÉ b·∫≠t / t·∫Øt</button>
      <p>Tr·∫°ng th√°i LED 3: <span id='state3'>ƒê√£ T·∫Øt</span></p>
      <button id='toggleBtn3' class='btn' onclick='toggleLED3()'>Nh·∫•n ƒë·ªÉ b·∫≠t / t·∫Øt</button>
    </div>
  </div>
  <div>
    <div class='card'>
      <iframe src='https://thingspeak.com/channels/2637039/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=30&title=Nhi%E1%BB%87t+%C4%91%E1%BB%99&type=line'></iframe>
    </div>
    <div class='card'>
      <iframe src='https://thingspeak.com/channels/2637039/charts/2?bgcolor=%23ffffff&color=%23009688&dynamic=true&results=30&title=%C4%90%E1%BB%99+%E1%BA%A9m&type=line'></iframe>
    </div>
    <div class='card'>
      <h2>üè´ Tr∆∞·ªùng ƒêH C√¥ng nghi·ªáp IUH</h2>
      <img src='https://rubee.com.vn/wp-content/uploads/2021/05/Logo-IUH.jpg' alt='IUH' align-items: center>
    </div>
    <button class="btn" style="background:#f44336;color:white;" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  </div>
</div>
</div>

<script>
let ledState1 = 0;
let ledState2 = 0;
let ledState3 = 0;
let mode = 'manual';

// --- API KEY + Channel ---
let writeAPI = "PXW7LEWFTB7KXA3M"; // <-- WRITE API KEY
let readAPI = "MG3QHGIIU9UT6SPF";  // <-- READ API KEY
let channelID = "2651233";

// --- G·ª≠i d·ªØ li·ªáu l√™n ThingSpeak ---
function sendToThingSpeak(field, value, btnId) {
  let url = `https://api.thingspeak.com/update?api_key=${writeAPI}&${field}=${value}`;
  fetch(url).then(r => r.text()).then(data => {
    console.log("ThingSpeak response:", data);
    if (data === "0") {
      alert("‚ö†Ô∏è G·ª≠i th·∫•t b·∫°i (gi·ªõi h·∫°n 15s). Th·ª≠ l·∫°i sau.");
    }
  });
  if (btnId) lockButton(btnId);
}

// --- Toggle LED 1 ---
function toggleLED1() {
  if(mode === 'manual') {
    ledState1 = ledState1 ? 0 : 1;
    updateLED1();
    sendToThingSpeak("field1", ledState1, "toggleBtn1");
  }
}

// --- Toggle LED 2 ---
function toggleLED2() {
  if(mode === 'manual') {
    ledState2 = ledState2 ? 0 : 1;
    updateLED2();
    sendToThingSpeak("field2", ledState2, "toggleBtn2");
  }
}

// --- Toggle LED 3 ---
function toggleLED3() {
  if(mode === 'manual') {
    ledState3 = ledState3 ? 0 : 1;
    updateLED3();
    sendToThingSpeak("field3", ledState3, "toggleBtn3");
  }
}

// --- Toggle Mode ---
function toggleMode() {
  mode = (mode === 'manual') ? 'auto' : 'manual';
  updateMode();
  sendToThingSpeak("field4", mode === 'auto' ? 1 : 0, "modeBtn");
}

// --- C·∫≠p nh·∫≠t LED UI ---
function updateLED1() {
  let btn=document.getElementById('toggleBtn1');
  let state=document.getElementById('state1');
  if(ledState1){
    state.innerText='ƒê√£ B·∫≠t';
    btn.classList.add('on');
  } else {
    state.innerText='ƒê√£ T·∫Øt';
    btn.classList.remove('on');
  }
}

// --- C·∫≠p nh·∫≠t LED UI ---
function updateLED2() {
  let btn=document.getElementById('toggleBtn2');
  let state=document.getElementById('state2');
  if(ledState2){
    state.innerText='ƒê√£ B·∫≠t';
    btn.classList.add('on');
  } else {
    state.innerText='ƒê√£ T·∫Øt';
    btn.classList.remove('on');
  }
}

// --- C·∫≠p nh·∫≠t LED UI ---
function updateLED3() {
  let btn=document.getElementById('toggleBtn3');
  let state=document.getElementById('state3');
  if(ledState3){
    state.innerText='ƒê√£ B·∫≠t';
    btn.classList.add('on');
  } else {
    state.innerText='ƒê√£ T·∫Øt';
    btn.classList.remove('on');
  }
}

// --- C·∫≠p nh·∫≠t Mode UI ---
function updateMode() {
  let btn = document.getElementById('modeBtn');
  let state = document.getElementById('modeState');
  let toggleBtn1 = document.getElementById('toggleBtn1');
  let toggleBtn2 = document.getElementById('toggleBtn2');
  let toggleBtn3 = document.getElementById('toggleBtn3');

  if (mode === 'auto') {
    state.innerText = 'Auto';
    btn.classList.add('auto');
    autoSettings.style.display = 'block'; // hi·ªán ph·∫ßn nh·∫≠p gi·ªù

    // Kh√≥a 3 n√∫t LED
    [toggleBtn1, toggleBtn2, toggleBtn3].forEach(b => {
      b.disabled = true;
      b.style.opacity = 0.5;
      b.style.cursor = 'not-allowed';
    });

  } else {
    state.innerText = 'Manual';
    btn.classList.remove('auto');
    autoSettings.style.display = 'none'; // ·∫©n ph·∫ßn nh·∫≠p gi·ªù

    // M·ªü kh√≥a 3 n√∫t LED
    [toggleBtn1, toggleBtn2, toggleBtn3].forEach(b => {
      b.disabled = false;
      b.style.opacity = 1;
      b.style.cursor = 'pointer';
    });
  }
}

function sendTimeToThingSpeak() {
  let startTime = document.getElementById("startTime").value.trim();
  let stopTime  = document.getElementById("stopTime").value.trim();

  // Ki·ªÉm tra h·ª£p l·ªá (ƒë·ªß 4 s·ªë)
  if (startTime.length !== 4 || stopTime.length !== 4) {
    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß 4 ch·ªØ s·ªë cho c·∫£ hai th·ªùi gian!");
    return;
  }

  // Gh√©p th√†nh 8 s·ªë (VD: 18302230)
  let timeData = startTime + stopTime;

  let url = `https://api.thingspeak.com/update?api_key=${writeAPI}&field5=${timeData}`;
  
  fetch(url)
    .then(res => res.text())
    .then(data => {
      if (data === "0") alert("‚ö†Ô∏è G·ª≠i th·∫•t b·∫°i (do gi·ªõi h·∫°n 15s).");
      else alert(`‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng: ${timeData}`);
    })
    .catch(err => alert("‚ùå L·ªói khi g·ª≠i: " + err));
}

// --- ƒê·ªçc tr·∫°ng th√°i m·ªõi nh·∫•t t·ª´ ThingSpeak ---
function fetchThingSpeak() {
  let url = `https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${readAPI}`;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      console.log("ThingSpeak data:", data);

      // LED state (field1)
      if (data.field1 !== null) {
        ledState1 = (data.field1 === "1") ? 1 : 0;
        updateLED1();
      }

           // LED state (field3)
      if (data.field2 !== null) {
        ledState2 = (data.field2 === "1") ? 1 : 0;
        updateLED2();
      }

      // LED state (field3)
      if (data.field3 !== null) {
        ledState3 = (data.field3 === "1") ? 1 : 0;
        updateLED3();
      }

      // Mode (field4)
      if (data.field4 !== null) {
        mode = (data.field4 === "1") ? "auto" : "manual";
        updateMode();
      }
    })
    .catch(err => console.error("Error fetching:", err));
}

// --- Kh√≥a n√∫t 15s ---
function lockButton(btnId) {
  let btn = document.getElementById(btnId);
  btn.disabled = true;
  let oldText = btn.innerText;
  let countdown = 15;
  btn.innerText = oldText + ` (${countdown})`;
  btn.style.opacity = 0.5;
  btn.style.cursor = "not-allowed";

  let timer = setInterval(() => {
    countdown--;
    if (countdown > 0) {
      btn.innerText = oldText + ` (${countdown})`;
    } else {
      clearInterval(timer);
      btn.disabled = false;
      btn.innerText = oldText;
      btn.style.opacity = 1;
      btn.style.cursor = "pointer";
    }
  }, 1000);
}

function logout() {
  sessionStorage.clear();
  window.location.href = "login.html";
}

// --- ƒê·ªìng h·ªì ---
function updateClock(){
  let now = new Date();
  let hours = String(now.getHours()).padStart(2,'0');
  let minutes = String(now.getMinutes()).padStart(2,'0');
  let seconds = String(now.getSeconds()).padStart(2,'0');
  let date = now.getDate()+'/'+(now.getMonth()+1)+'/'+now.getFullYear();
  document.getElementById('clock-date').innerText ='Ng√†y h√¥m nay: ' + date;
  document.getElementById('clock').innerText = 'Gi·ªù hi·ªán t·∫°i: ' + hours+':'+minutes+':'+seconds;
}
setInterval(updateClock,1000);
updateClock();

// --- G·ªçi API ThingSpeak m·ªói 5 gi√¢y ƒë·ªÉ ƒë·ªìng b·ªô ---
setInterval(fetchThingSpeak, 5000);
fetchThingSpeak();
</script>
</body>
</html>











