<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Điều khiển đèn ESP32</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0081C2, #042F60);
      color: white;
      text-align: center;
      padding: 50px;
    }
    h1 {
      margin-bottom: 20px;
    }
    #ledButton {
      padding: 15px 30px;
      font-size: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
    }
    .on {
      background-color: red;
    }
    .off {
      background-color: green;
    }
  </style>
</head>
<body>
  <h1>💡 Điều khiển đèn ESP32</h1>
  <button id="ledButton" class="off" onclick="toggleLED()">Bật đèn</button>

  <script>
    // --- Cấu hình ThingSpeak ---
    const writeAPIKey = "GRCJC30IIGGHI4SX";   // API key ghi (điều khiển LED)
    const readAPIKey  = "MG3QHGIIU9UT6SPF";   // API key đọc
    const channelID   = "2651233";

    let currentState = "0"; // mặc định đèn tắt

    // Gửi lệnh bật/tắt LED
    function toggleLED() {
      let newState = (currentState === "1") ? "0" : "1";
      fetch(`https://api.thingspeak.com/update?api_key=${writeAPIKey}&field1=${newState}`)
        .then(response => response.text())
        .then(data => {
          if (data !== "0") {
            currentState = newState;
            updateButton();
          } else {
            alert("⚠️ Gửi lệnh thất bại!");
          }
        });
    }

    // Cập nhật giao diện nút
    function updateButton() {
      const btn = document.getElementById("ledButton");
      if (currentState === "1") {
        btn.innerText = "Tắt đèn";
        btn.classList.remove("off");
        btn.classList.add("on");
      } else {
        btn.innerText = "Bật đèn";
        btn.classList.remove("on");
        btn.classList.add("off");
      }
    }

    // Đọc trạng thái LED từ ThingSpeak
    function fetchLEDState() {
      fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1/last.txt?api_key=${readAPIKey}`)
        .then(response => response.text())
        .then(state => {
          state = state.trim();
          if (state === "0" || state === "1") {
            currentState = state;
            updateButton();
          }
        });
    }

    // Auto sync mỗi 3s
    setInterval(fetchLEDState, 3000);

    // Sync ngay khi load trang
    window.onload = fetchLEDState;
  </script>
</body>
</html>
